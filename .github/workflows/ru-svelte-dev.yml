name: Deploy ru.svelte.dev site

on:
  push:
    paths:
      - 'repositories/sveltejs/svelte/*'
      - 'repositories/sveltejs/svelte/*/*'
      - 'repositories/sveltejs/svelte/*/*/*'
      - 'repositories/sveltejs/svelte/*/*/*/*'
      - 'repositories/sveltejs/svelte/*/*/*/*/*'
      - 'repositories/sveltejs/svelte/*/*/*/*/*/*'
      - 'repositories/sveltejs/svelte/*/*/*/*/*/*/*'
      - 'repositories/sveltejs/svelte/*/*/*/*/*/*/*/*'

jobs:

  build:
    runs-on: ubuntu-latest
 
    steps:
      - uses: actions/checkout@v1
      - name: Build & Push the Docker image
        run: |
          docker login docker.pkg.github.com -u AlexxNB -p ${{ secrets.PKG_TOKEN }}
          docker build . --file  deploy/svelte-site.dockerfile --tag docker.pkg.github.com/AlexxNB/svelte3-translation-ru/ru-svelte-dev:latest
          docker push docker.pkg.github.com/AlexxNB/svelte3-translation-ru/ru-svelte-dev:latest

      - name: Copy docker-compose file to the server
        uses: garygrossgarten/github-action-scp@release
        with:
          local: deploy/docker-compose.yml
          remote: /tmp/svelte/docker-compose.yml
          host: ru.svelte.dev
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASS }}

      - name: Restarting ru.svelte.dev container
        uses: garygrossgarten/github-action-ssh@release
        with:
          command: cd /tmp/svelte && docker-compose pull svelte && docker-compose up svelte --detach --force-recreate && rm -rf /tmp/svelte && docker image prune -a -f
          host: ru.svelte.dev
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASS }}
